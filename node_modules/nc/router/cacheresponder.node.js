var fs = require('fs');
var path = require('path');
var pathManager = require('nc/pathmanager');
var cache = require('nc/cache');

var CacheResponder = new (function() {
	var self = this;
	var unrefreshableRegex = /[.](js|css|less)$/;
	var unrefreshables = {};
	
	self.cacheMap = function(resourceCacheMap, neverRefresh) {
		var i;
		for(i in resourceCacheMap) {
			cache.set('plain:' + i, resourceCacheMap[i]);
		}
		
		if(neverRefresh) {
			for(i in resourceCacheMap) {
				unrefreshables[i] = true;
			}
		}
	}
	
	self.cache = function(index, content, neverRefresh) {
		cache.set('plain:' + index, content);
		if(neverRefresh) {
			unrefreshables[index] = true;
		}
	}
	
	self.uncache = function(index) {
		cache.clear('plain:' + index);
		
		if(unrefreshables[index]) {
			delete unrefreshables[index];
		}
	}
	
	self.run = function(req, res, next) {
		var cacheKey = req.rout.encoding + ':' + req.url;
		var refreshable = !unrefreshables.hasOwnProperty(req.url) && (!unrefreshableRegex.test(req.url) || req.params.ck);
		if(req.params.ck && refreshable) {
			next();
		} else {
			if(cache.has(cacheKey)) {
				res.writeHead(200);
				res.end(cache.get(cacheKey));
			} else {
				if(req.rout.encoding != 'plain') {
					var plainCacheKey = 'plain:' + req.url;
					if(cache.has(plainCacheKey)) {
						req.rout.buffer = cache.get(plainCacheKey);
					}
				}
				next();
			}
		}
	}
})();

module.exports = CacheResponder;
