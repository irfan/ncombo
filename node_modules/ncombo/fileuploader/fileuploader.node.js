var fs = require('fs'),
	util = require('util'),
	path = require('path'),
	json = require('../../../framework/libs/json2'),
	Stream = require('stream').Stream,
	Buffer = require('buffer').Buffer,
	formidable = require('formidable');

var FileUploader = new (function() {
	var self = this;
	self._options = {
		uploadURL: '/~upload',
		tmpDir: __dirname + '/tmp/',
		uploadDir: __dirname + '/../../../app/files/',
		maxPostSize: 500000000,
		maxFileSize: 100000000
	}
	
	self._validateFile = function(file) {
		if(self._options.maxFileSize && file.size > self._options.maxFileSize) {
			return false;
		}
		return true;
	}
	
	self._writeFileChunks = function(fd, chunks, index, callback) {
		if(index < chunks.length) {
			fs.write(fd, chunks[index], null, chunks[index].length, null, function() {
				self._writeFileChunks(fd, chunks, index+1, callback);
			});
		} else {
			fs.close(fd);
			callback('{"success": true}');
		}
	}
	
	self.upload = function(req, res, next) {
		if(req.method == 'POST' && req.url == self._options.uploadURL) {
			res.setHeader('Pragma', 'no-cache');
            res.setHeader('Cache-Control', 'no-cache, must-revalidate');
			if(req.headers['content-type'] == 'application/octet-stream') {
				var session = req.session;
				var fileName = req.headers['x-file-name'];
				var tempPath = self._options.tmpDir + '/' + fileName;
				var bytesLoaded = 0;
				var bytesTotal = parseInt(req.headers['content-length']);
				
				var uploadPath;
				if(req.uploadPath) {
					uploadPath = req.uploadPath;
				} else {
					uploadPath = path.normalize(self._options.uploadDir + fileName);
				}
				var destStream = fs.createWriteStream(tempPath, {flags: 'w'});
				
				var progressHandler = function(chunk) {
					bytesLoaded += chunk.length;
					destStream.write(chunk);
					
					session && session.emit('uploadprogress', {bytesLoaded: bytesLoaded, bytesTotal: bytesTotal});
				}
				
				var errorHandler = function(err) {
					req.removeListener('error', errorHandler);
					req.removeListener('data', progressHandler);
					req.removeListener('end', finish);
					destStream.end();
					fs.unlink(tempPath);
					
					res.end('{"success": false}');
					session && session.emit('uploadfail');
				}
				
				var finish = function() {
					req.removeListener('error', errorHandler);
					req.removeListener('data', progressHandler);
					req.removeListener('end', finish);
					destStream.end();
					fs.rename(tempPath, uploadPath);
					
					res.end('{"success": true}');
					session && session.emit('uploadcomplete');
				}
				
				req.on('data', progressHandler);
				req.on('error', errorHandler);
				req.on('end', finish);
				
			} else if(/^multipart\/form-data;/.test(req.headers['content-type'])) {
				var session = req.session;
				
				var form = new formidable.IncomingForm();
				var finished = false;
				var error = false;
				
				form.on('progress', function(bytesReceived, bytesExpected) {
					session && session.emit('uploadprogress', {bytesLoaded: bytesReceived, bytesTotal: bytesExpected});
				});
				
				var setFinish = function() {
					finished = true;
				}
				
				var setError = function() {
					error = true;
				}
				
				form.on('end', setFinish);
				form.on('error', setError);
				
				var finish = function(tempPath, uploadPath) {
					finished = true;
					fs.rename(tempPath, uploadPath);
					res.end('{"success": true}');
					session && session.emit('uploadcomplete');
				}
				
				var fail = function(tempPath) {
					finished = true;
					fs.unlink(tempPath);
					res.end('{"success": false}');
					session && session.emit('uploadfail');
				}
				
				form.parse(req, function(err, fields, files) {
					var qqFile = files.qqfile;
					var fileName = qqFile.name;					
					
					var uploadPath;
					if(req.uploadPath) {
						uploadPath = req.uploadPath;
					} else {
						uploadPath = self._options.uploadDir + fileName;
					}
					
					var tempPath = qqFile.path;
					
					var ended = false;
					
					var onFinish = function() {
						form.removeListener('end', onFinish);
						form.removeListener('error', onError);
						finish(tempPath, uploadPath);
					}
					
					var onError = function() {
						form.removeListener('end', onFinish);
						form.removeListener('error', onError);
						fail(tempPath);
					}
					
					form.removeListener('end', setFinish);
					if(finished) {
						finish(tempPath, uploadPath);
					} else if(error) {
						fail();
					} else {
						form.on('end', onFinish);
						form.on('error', onError);
					}
				});
			} else {
				res.end('{"success": false}');
			}
		} else {
			next(req, res);
		}
	}
})();

module.exports = FileUploader;
