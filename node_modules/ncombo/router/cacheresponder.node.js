var fs = require('fs');
var path = require('path');
var cache = require('ncombo/cache');

var CacheResponder = new (function() {
	var self = this;
	
	self.cacheMap = function(resourceCacheMap) {
		var i;
		for(i in resourceCacheMap) {
			cache.set('plain:' + i, resourceCacheMap[i]);
		}
	}
	
	self.run = function(req, res, next) {
		var cacheKey = req.rout.encoding + ':' + req.url;
		
		if(req.params.ck) {
			next();
		} else {
			if(cache.has(cacheKey)) {
				res.writeHead(200);
				res.end(cache.get(cacheKey));
			} else {
				if(req.rout.encoding != 'plain') {
					var plainCacheKey = 'plain:' + req.url;
					if(cache.has(plainCacheKey)) {
						req.rout.buffer = cache.get(plainCacheKey);
					}
				}
				next();
			}
		}
	}
})();

module.exports = CacheResponder;
