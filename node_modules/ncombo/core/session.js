var NCOMBO_SOCKET = io.connect('{{endpoint}}');

var IE = false;
var IE_VERSION = 0;

if(/MSIE (\d+\.\d+);/.test(navigator.userAgent)) {
	IE = true;
	IE_VERSION = new Number(RegExp.$1)
}

function setCookie(name, value, exdays) {
	var exdate = new Date();
	exdate.setDate(exdate.getDate() + exdays);
	var value = escape(value) + '; path=/;' + ((exdays == null) ? "" : " expires=" + exdate.toUTCString() + ";");
	document.cookie = name + "=" + value;
}

function getCookie(name) {
    var i, x, y, ARRcookies = document.cookie.split(";");
    for(i = 0; i < ARRcookies.length; i++) {
        x = ARRcookies[i].substr(0, ARRcookies[i].indexOf("="));
        y = ARRcookies[i].substr(ARRcookies[i].indexOf("=") + 1);
        x = x.replace(/^\s+|\s+$/g, "");
        if(x == name) {
            return unescape(y);
        }
    }
}

var _getHTTPReqObject = function() {
	var xmlhttp = null;
	if(IE) {
		try {
			xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
		} catch (exceptionA) {
			try {
				xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
			} catch (exceptionB) {
				xmlhttp = null;
			}
		}
	}
	if (!xmlhttp && typeof XMLHttpRequest != 'undefined') {
		try {
			xmlhttp = new XMLHttpRequest();
		} catch (e) {
			xmlhttp = null;
		}
	}
	if(!xmlhttp) {
		throw "Could not instantiate XMLHttpRequest";
	}
	return xmlhttp;
}

var ajax = function(settings) {
	var type;
	if(settings.type) {
		type = settings.type;
	} else {
		type = "GET";
	}

	var xmlhttp = _getHTTPReqObject();
	xmlhttp.open(type, settings.url, true);
	xmlhttp.onreadystatechange = function() {
		if(xmlhttp.readyState == 4) {
			if(xmlhttp.status == 200) {
				if(settings.success) {
					settings.success(xmlhttp.responseText);
				}
			} else {
				if(settings.error) {
					settings.error(xmlhttp.statusText);
				} else {
					throw "Failed to load resource: " + url;
				}
			}
		}
	}
	xmlhttp.send();
}

NCOMBO_SOCKET.on('connect', function() {
	var sessionID = NCOMBO_SOCKET.socket.sessionid;
	
	setCookie('sid', sessionID);
	NCOMBO_SOCKET.emit('init');
	
	var head = document.getElementsByTagName('head');
	if(head) {
		head = head[0];
	}
	
	var onScriptLoad = function(scriptTag, callback) {
		if(!IE || IE_VERSION > 8) {
			scriptTag.onload = function() {
				callback();
			}
		} else {
			scriptTag.onreadystatechange = function() {
				if(this.readyState == 'complete' || this.readyState == 'loaded') {
					callback();
				}
			}
		}
	}
	
	var nComboStyle = document.createElement('link');
	nComboStyle.rel = 'stylesheet';
	nComboStyle.type = 'text/css';
	nComboStyle.href = location.href + 'node_modules/ncombo/styles/ncombo.css';
	
	var loadScript = document.createElement('script');
	loadScript.type = 'text/javascript';
	loadScript.src = location.href + 'node_modules/ncombo/loader.js';
	
	var scriptLoaded = false;
	
	onScriptLoad(loadScript, function() {
		scriptLoaded = true;
	});
	
	ajax({
		url: location.href + '~startscript',
		success: function(loaderCode) {
			head.appendChild(nComboStyle);
			head.appendChild(loadScript);
			
			if(scriptLoaded) {
				eval(loaderCode);
			} else {
				onScriptLoad(loadScript, function() {
					eval(loaderCode);
				});
			}
		}
	});
});