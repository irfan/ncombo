var NCOMBO_PORT = {{port}};
var NCOMBO_SOCKET = io.connect('{{endpoint}}');

var IE = false;
var IE_VERSION = 0;

if(/MSIE (\d+\.\d+);/.test(navigator.userAgent)) {
	IE = true;
	IE_VERSION = new Number(RegExp.$1)
}

var spinnerOpts = {
  lines: 8,
  length: 5,
  width: 3,
  radius: 7,
  corners: 0,
  rotate: 0,
  color: '#666',
  speed: 1,
  trail: 60,
  shadow: false,
  hwaccel: false,
  className: 'spinner',
  zIndex: 2e9,
  top: 'auto',
  left: 'auto'
};

var spinnerDiv = document.createElement('div');

spinnerDiv.style.width = spinnerOpts.radius * 2 + 'px';
spinnerDiv.style.height = spinnerOpts.radius * 2 + 'px';
spinnerDiv.style.position = 'absolute';
spinnerDiv.style.left = '50%';
spinnerDiv.style.top = '50%';

var spinner = new Spinner(spinnerOpts).spin(spinnerDiv);

var appendSpinner = function() {
	document.body.appendChild(spinnerDiv);
}

var bodyReadyInterval = setInterval(function() {
	if(document.body) {
		clearInterval(bodyReadyInterval);
		appendSpinner();
	}
}, 20);

function setCookie(name, value, exdays) {
	var exdate = new Date();
	exdate.setDate(exdate.getDate() + exdays);
	var value = escape(value) + '; path=/;' + ((exdays == null) ? "" : " expires=" + exdate.toUTCString() + ";");
	document.cookie = name + "=" + value;
}

function getCookie(name) {
    var i, x, y, ARRcookies = document.cookie.split(";");
    for(i = 0; i < ARRcookies.length; i++) {
        x = ARRcookies[i].substr(0, ARRcookies[i].indexOf("="));
        y = ARRcookies[i].substr(ARRcookies[i].indexOf("=") + 1);
        x = x.replace(/^\s+|\s+$/g, "");
        if(x == name) {
            return unescape(y);
        }
    }
}

var _getHTTPReqObject = function() {
	var xmlhttp = null;
	if(IE) {
		try {
			xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
		} catch (exceptionA) {
			try {
				xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
			} catch (exceptionB) {
				xmlhttp = null;
			}
		}
	}
	if (!xmlhttp && typeof XMLHttpRequest != 'undefined') {
		try {
			xmlhttp = new XMLHttpRequest();
		} catch (e) {
			xmlhttp = null;
		}
	}
	if(!xmlhttp) {
		throw "Could not instantiate XMLHttpRequest";
	}
	return xmlhttp;
}

var ajax = function(settings) {
	var type;
	if(settings.type) {
		type = settings.type;
	} else {
		type = "GET";
	}

	var xmlhttp = _getHTTPReqObject();
	xmlhttp.open(type, settings.url, true);
	xmlhttp.onreadystatechange = function() {
		if(xmlhttp.readyState == 4) {
			if(xmlhttp.status == 200) {
				if(settings.success) {
					settings.success(xmlhttp.responseText);
				}
			} else {
				if(settings.error) {
					settings.error(xmlhttp.statusText);
				} else {
					throw "Failed to load resource: " + url;
				}
			}
		}
	}
	xmlhttp.send();
}

var globalEval = function(src) {
	if(window.execScript) {
		window.execScript(src);
	} else {
		(function() {
			window.eval.call(window, src);
		})();
	}
}

NCOMBO_SOCKET.on('connect', function() {
	var sessionID = NCOMBO_SOCKET.socket.sessionid;
	
	setCookie('ncsid', sessionID);
	
	var head = document.getElementsByTagName('head');
	if(head) {
		head = head[0];
	}
	
	var onScriptLoad = function(scriptTag, callback) {
		if(!IE || IE_VERSION > 8) {
			scriptTag.onload = function() {
				callback();
			}
		} else {
			scriptTag.onreadystatechange = function() {
				if(this.readyState == 'complete' || this.readyState == 'loaded') {
					callback();
				}
			}
		}
	}
	
	var nComboStyle = document.createElement('link');
	nComboStyle.rel = 'stylesheet';
	nComboStyle.type = 'text/css';
	nComboStyle.href = smartCacheManager.setURLCacheVersion('/node_modules/ncombo/styles/ncombo.css');
	
	var loadScript = document.createElement('script');
	loadScript.type = 'text/javascript';
	loadScript.src = smartCacheManager.setURLCacheVersion('/node_modules/ncombo/loader.js');
	
	var scriptLoaded = false;
	
	onScriptLoad(loadScript, function() {
		scriptLoaded = true;
	});
	
	NCOMBO_SOCKET.on('ready', function() {
		ajax({
			url: '/~startscript',
			success: function(loaderCode) {
				head.appendChild(nComboStyle);
				head.appendChild(loadScript);
				
				if(scriptLoaded) {
					document.body.removeChild(spinnerDiv);
					globalEval(loaderCode);
				} else {
					onScriptLoad(loadScript, function() {
						document.body.removeChild(spinnerDiv);
						globalEval(loaderCode);
					});
				}
			}
		});
	});
});
