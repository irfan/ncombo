var fs = require('fs'),
	json = require('ncombo/libs/json2'),
	formidable = require('formidable');

var FileUploader = new (function() {
	var self = this;
	self._options = {
		uploadURL: '/~upload',
		tmpDir: __dirname + '/tmp/',
		uploadDir: __dirname + '/../../../../app/files/',
		maxPostSize: 500000000,
		maxFileSize: 100000000
	}
	
	self._validateFile = function(file) {
		if(self._options.maxFileSize && file.size > self._options.maxFileSize) {
			return false;
		}
		return true;
	}
	
	self._writeFileChunks = function(fd, chunks, index, callback) {
		if(index < chunks.length) {
			fs.write(fd, chunks[index], null, chunks[index].length, null, function() {
				self._writeFileChunks(fd, chunks, index+1, callback);
			});
		} else {
			fs.close(fd);
			callback('{"success": true}');
		}
	}
	
	self.upload = function(req, res, next) {
		if(req.method == 'POST' && req.url == self._options.uploadURL) {
			res.setHeader('Pragma', 'no-cache');
            res.setHeader('Cache-Control', 'no-cache, must-revalidate');
			
			if(req.headers['content-type'] == 'application/octet-stream') {
				var session = req.session;
				var fileName = req.headers['x-file-name'];
				var tempPath = self._options.tmpDir + '/' + fileName;
				var buf = [];
				
				var ended = false;
				var bytesLoaded = 0;
				var bytesTotal = parseInt(req.headers['content-length']);
				
				var progressHandler = function(chunk) {
					buf.push(chunk);
					bytesLoaded += chunk.length;
					
					session.emit('uploadprogress', {bytesLoaded: bytesLoaded, bytesTotal: bytesTotal});
				}
				
				req.on('data', progressHandler);
				
				var endFunc = function() {
					ended = true;
				}
				
				req.on('end', endFunc);
				
				if(req.uploadPath) {
					var uploadPath = req.uploadPath;
				} else {
					var uploadPath = self._options.uploadDir + fileName;
				}
				
				var fd;
				
				var finish = function() {
					req.removeListener('end', finish);
					req.removeListener('data', progressHandler);
					self._writeFileChunks(fd, buf, 0, function(result) {
						fs.rename(tempPath, uploadPath);
						res.end(result);
						session.emit('uploadcomplete');
					});
				}
				
				fs.open(tempPath, 'w+', function(err, fileDesc) {
					if(ended) {
						fd = fileDesc;
						finish();
					} else {
						fd = fileDesc;
						req.removeListener('end', endFunc);
						req.on('end', finish);
					}
				});
			} else {
				res.end('{"success": false}');
			}
		} else {
			next(req, res);
		}
	}
})();

module.exports = FileUploader;