var fs = require('fs');
var path = require('path');
var pathManager = require('ncombo/pathmanager');
var EventEmitter = require('events').EventEmitter;
var chokidar = require('chokidar');

module.exports = function(options) {
	var self = new EventEmitter();
	
	var specialCharsRegex = /[\r\n\t]/g;
	var singleQuoteRegex = /'/g;
	var files = options.files;
	var watch = options.watch;
	
	if(watch) {
		var emitBundle = function() {
			self.emit('bundle');
		}
		var watcher = chokidar.watch(files);
		watcher.on('change', emitBundle);
		watcher.on('unlink', emitBundle);
	}
	
	self._stringifyHTML = function(content) {
		return content.replace(specialCharsRegex, '').replace(singleQuoteRegex, "\\'");
	}
	
	self._genTemplateCode = function(filePath) {
		var url = pathManager.pathToURL(filePath);
		var content = fs.readFileSync(filePath, 'utf8');
		var code = "$loader.grab._loadableResourceMap['" + url + "'] = new $loader.Template('" + url + "');\n";
		code += "$loader.grab._loadableResourceMap['" + url + "'].make('" + self._stringifyHTML(content) + "');\n";
		return code;
	}
	
	self.bundle = function() {
		if(!(files instanceof Array)) {
			files = [files];
		}
		var content = [];
		
		var i, file;
		for(i in files) {
			file = files[i];
			content.push(self._genTemplateCode(file));
		}
		
		return content.join('\n');
	}
	
	return self;
}